ğŸ”­ **Highâ€‘level objective**
Refactor the current SpecProjâ€‘UNet codebase so that it supports a *joint forwardâ€“inverse paradigm* inspired by the ICLRâ€‘25 paper â€œA Unified Framework for Forward and Inverse Problems in Subâ€‘surface Imaging Using Latentâ€‘Space Translationsâ€ (ICLR25FWI).
Keep the existing physicsâ€‘guided splitter (Î Â± masks) **unchanged** while inserting a lightweight IUâ€‘Net latent translator and its Mooreâ€“Penrose assembler.  All unrelated functionality (data I/O, CLI entryâ€‘points, Docker, CI) must remain intact.

```
Hierarchy key
â”‚  â”œâ”€ taskâ€‘group               # highâ€‘level refactor phase
â”‚  â”‚   â”œâ”€ [file.py]            # file to create / edit (absolute path â‰¡ repoâ€‘root)
â”‚  â”‚   â”‚    â— promptâ€‘ID        # short, unique tag
â”‚  â”‚   â”‚      â”œâ”€ instruction   # one atomic edit that Cursor will apply
â”‚  â”‚   â”‚      â””â”€ â€¦             # subâ€‘edits executed depthâ€‘first
```

## 0â€‚Preâ€‘flight sanity

â”‚  â”œâ”€ \[.github/workflows/ci.yml]
â”‚  â”‚    â— ciâ€‘01
â”‚  â”‚      â”œâ”€ ensure â€œpytest -qâ€ and â€œpython -m py\_compile \$(git ls-files '\*.py')â€ still run in CI on **every branch push**.
â”‚  â”‚      â””â”€ add job `dryrun` that executes `python src/core/train.py --dryrun` (one miniâ€‘batch) on CPU.
â”‚  â””â”€ \[.preâ€‘commit-config.yaml]
â”‚       â— lintâ€‘01 â†’ add ruff+black hooks; lineâ€‘length 120.

## 1â€‚Singleton config upgrades

â”‚  â”œâ”€ \[src/core/config.py]
â”‚  â”‚    â— cfgâ€‘01 â†’ add flags: `enable_joint`, `latent_h`, `latent_w`, `Î»_fwd`, `Î»_inv`, with sensible defaults (False/16/16/1.0/1.0).
â”‚  â”‚    â— cfgâ€‘02 â†’ expose helper `is_joint()` returning bool for fast checks.
â”‚  â””â”€ \[README.md]
â”‚       â— docâ€‘01 â†’ document new flags in *Environmentâ€‘specific setup* section.

## 2â€‚Data utilities (no change needed)

(No edits unless later tasks require.)

## 3â€‚Physics layer â€“ add pseudoâ€‘inverse assembler

â”‚  â”œâ”€ \[src/core/proj\_mask.py]
â”‚  â”‚    â— physâ€‘01 â†’ add class `SpectralAssembler` implementing Î Â±â€  using small Îµâ€‘regularised Mooreâ€“Penrose inverse.  Signature:
â”‚  â”‚         `def forward(self, up:Tensor, down:Tensor)->Tensor` returning reconstructed wavefield.
â”‚  â”‚    â— physâ€‘02 â†’ expose functional helper `split_and_reassemble(x)` for quick unit tests.
â”‚  â”‚    â— physâ€‘03 â†’ write docstring with equation references (Â§1 answer above).

## 4â€‚Latent translator â€“ IUâ€‘Net miniâ€‘module

â”‚  â”œâ”€ \[src/core/iunet.py]  # **NEW**
â”‚  â”‚    â— iuâ€‘00 â†’ create file; implement bidirectional IUâ€‘Net (â‰ˆ24â€¯M params) with coupling layers; default latent grid (latent\_hÃ—latent\_w from CFG).
â”‚  â”‚    â— iuâ€‘01 â†’ `def forward(self, z, direction:str)` where direction âˆˆ {"pâ†’v","vâ†’p"}.
â”‚  â”‚    â— iuâ€‘02 â†’ unit test in `tests/test_iunet.py` (create if missing).
â”‚  â””â”€ \[requirements.txt]
â”‚       â— reqâ€‘01 â†’ add `frâ€‘eunet` or custom blocks if extra dep is needed (keep torch>=2.1).

## 5â€‚Model wrapper â€“ HybridSpecProj

â”‚  â”œâ”€ \[src/core/specproj\_hybrid.py]  # **NEW**
â”‚  â”‚    â— hybâ€‘00 â†’ compose: PhysMask â†’ (up,down) â†’ IUâ€‘Net translation â†’ decoders
â”‚  â”‚    â— hybâ€‘01 â†’ for inverseâ€‘only run, skip IUâ€‘Net path and fall back to existing SmallUNets.
â”‚  â”‚    â— hybâ€‘02 â†’ for joint mode: (a) velocity decoder == old SmallUNet; (b) new `WaveDecoder` (2 convâ€‘upsample blocks) producing pâ€‘pred; losses handled in losses.py.
â”‚  â”‚    â— hybâ€‘03 â†’ expose `forward(seis, mode:str)` returning tuple (v\_pred, p\_pred or None).
â”‚  â””â”€ \[src/core/specproj\_unet.py]
â”‚       â— unetâ€‘01 â†’ *deprecate* direct use; reâ€‘export HybridSpecProj as `SpecProjUNet` for backwards compatibility when `CFG.enable_joint` is False.

## 6â€‚Losses

â”‚  â”œâ”€ \[src/core/losses.py]
â”‚  â”‚    â— lossâ€‘01 â†’ add `JointLoss(Î»_inv, Î»_fwd, Î»_pde)` combining MAE(v), MAE(p) and optional PDE residual.
â”‚  â”‚    â— lossâ€‘02 â†’ keep `HybridLoss` aliasing to `JointLoss` when `enable_joint=False` for API stability.

## 7â€‚Training script refactor

â”‚  â”œâ”€ \[src/core/train.py]
â”‚  â”‚    â— trainâ€‘01 â†’ add CLI flags `--enable_joint`, `--dryrun` (uses argparse).
â”‚  â”‚    â— trainâ€‘02 â†’ if joint: backâ€‘prop on combo loss; else keep current path.
â”‚  â”‚    â— trainâ€‘03 â†’ add minimal validation (MAE) every epoch.
â”‚  â”‚    â— trainâ€‘04 â†’ log CUDA memÂ usage and loss breakdown via tqdm postfix.
â”‚  â””â”€ \[src/core/infer.py]
â”‚       â— inferâ€‘01 â†’ support velocityâ€‘only inference when joint model is active (ignore p\_pred).

## 8â€‚Kaggle notebook generator

â”‚  â”œâ”€ \[src/utils/update\_kaggle\_notebook.py]
â”‚  â”‚    â— nbâ€‘01 â†’ ensure new files `iunet.py`, `specproj_hybrid.py` are stitched into notebook sections, preserving numbered headers.
â”‚  â”‚    â— nbâ€‘02 â†’ add cell that toggles `CFG.enable_joint` by setting env var.

## 9â€‚Unit tests & dryâ€‘run

â”‚  â”œâ”€ \[tests/test\_spectral.py] **NEW**
â”‚  â”‚    â— tstâ€‘01 â†’ assert âˆ¥Î â€ (Î (x))Â âˆ’Â xâˆ¥ / âˆ¥xâˆ¥ < 1eâ€‘3 on random tensor.
â”‚  â””â”€ \[tests/test\_hybrid\_forward.py] **NEW**
â”‚       â— tstâ€‘02 â†’ smokeâ€‘test: forward pass of HybridSpecProj(via dummy data) returns shapes (B,1,70,70) and optional p\_pred.

## 10â€‚Documentation

â”‚  â””â”€ \[theory\_notes.md]
â”‚       â— thâ€‘01 â†’ append paragraph comparing categoryâ€‘quotient view to latentâ€‘manifold assumption (cite Â§3 discussion).

---

### ğŸš§Â Updated TODO list

1. **Validation loop** â€“ implement SSIM + earlyâ€‘stopping (placeholder hooks in trainâ€‘03).
2. Hyperâ€‘param sweep script for `(latent_h,latent_w)` using validation slope criterion.
3. Ensemble driver: blend SpecProjâ€‘UNet (physicsâ€‘only) with HybridSpecProj outputs via uncertainty weighting.
4. Colab/Kaggle notebooks â€“ add sliders for latent size & Î» weights.
5. Expand `SpectralAssembler` to support frequencyâ€‘dependent Îµ.
6. Move hardâ€‘coded dt,dx into `config.py` after sanity check.
7. CPU fallback kernels in PhysMask (fftshiftÂ â†’Â torch.fft).
8. Publish `OpenFWI_JointBench.csv` benchmarking script; autoâ€‘generate leaderboard figures.

*Once all prompts above are applied and CI passes `dryrun`, remove `âš™ï¸ TODO` comments from code.*
